<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartFinder — Dispositivos Inteligentes</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
  /* Fondo gris claro */
  body {
    background-color: #f5f5f5 !important;
  }

  /* Personalizar botones (azul celeste) */
  .btn-primary {
    background-color: #00bfff !important; 
    border-color: #00bfff !important;
  }
  .btn-primary:hover, 
  .btn-primary:focus {
    background-color: #00a8e0 !important; 
    border-color: #00a8e0 !important;
  }

  /* Estilos finos para pulir UI */
  .navbar-brand span { font-weight: 700; letter-spacing: .3px; }
  .device-card img { object-fit: cover; height: 180px; }
  .badge-type { text-transform: capitalize; }
  .filter-chip { cursor: pointer; }
  .rating i { margin-right: 2px; }
  .spec-key { min-width: 140px; font-weight: 600; }
  .empty-hint { border: 1px dashed var(--bs-border-color); border-radius: .75rem; }
  .form-text.monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .pointer { cursor: pointer; }
  .table-fixed-2 { width: 2rem; }
  .table-fixed-5 { width: 5rem; }
</style>

</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#/">
        <i class="bi bi-cpu-fill"></i> <span>SmartFinder</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#/">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="#/admin">Administración</a></li>
        </ul>
        <form id="navSearchForm" class="d-flex" role="search">
          <input id="navSearchInput" class="form-control me-2" type="search" placeholder="Buscar dispositivos..." aria-label="Buscar">
          <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
        </form>
      </div>
    </div>
  </nav>

  <!-- MAIN APP -->
  <main class="container my-4" id="app"></main>

  <!-- TOASTS -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- APP JS -->
  <script>
  ;(() => {
    /* ============================== *
     *  Núcleo: EventBus + Utilidades *
     * ============================== */
    const EventBus = {
      events: new Map(),
      on(evt, cb){ (this.events.get(evt) ?? this.events.set(evt, []).get(evt)).push(cb) },
      emit(evt, payload){ (this.events.get(evt) || []).forEach(cb => cb(payload)) }
    }

    const Utils = {
      uid: () => crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).substring(2,9)),
      fmtPrice: v => typeof v === 'number' ? v.toLocaleString('es-CO',{style:'currency',currency:'COP'}) : v,
      fmtDate: iso => new Date(iso).toLocaleDateString('es-CO', {year:'numeric', month:'short'}),
      safeJSON: (str, fallback) => { try { return JSON.parse(str) } catch { return fallback } },
      qs: (sel, root=document) => root.querySelector(sel),
      qsa: (sel, root=document) => [...root.querySelectorAll(sel)],
      // Query params en hash (#/?q=...&brand=...)
      getQuery(){
        const h = location.hash || '#/';
        const [route, qp] = h.split('?');
        const params = new URLSearchParams(qp || '');
        return { route, params };
      },
      setQuery(paramsObj){
        const { route } = Utils.getQuery();
        const search = new URLSearchParams(paramsObj);
        location.hash = route + (search.toString() ? '?' + search.toString() : '');
      },
      showToast({title='Listo', body='', variant='primary', delay=2500}){
        const id = 't'+Date.now();
        const el = document.createElement('div');
        el.className = `toast align-items-center border-0 text-bg-${variant}`;
        el.id = id;
        el.role = 'status';
        el.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              <strong>${title}:</strong> ${body}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
          </div>`;
        Utils.qs('#toasts').appendChild(el);
        new bootstrap.Toast(el, { delay }).show();
      },
      stars(rating){
        const r = Math.max(1, Math.min(5, Number(rating)||1));
        return '<span class="rating text-warning">'+ '★'.repeat(r) + '<span class="text-muted">'+'★'.repeat(5-r)+'</span></span>';
      }
    };

    /* =================== *
     *  Infra: Data Store  *
     * =================== */
    const Store = (() => {
      const KEYS = {
        brands: 'sf_brands',
        devices: 'sf_devices',
        comments: 'sf_comments'
      };

      function seedIfEmpty(){
        if(!localStorage.getItem(KEYS.brands)){
          const brands = [
            { id: Utils.uid(), name: 'Apple' },
            { id: Utils.uid(), name: 'Samsung' },
            { id: Utils.uid(), name: 'Lenovo' },
            { id: Utils.uid(), name: 'Xiaomi' },
          ];
          localStorage.setItem(KEYS.brands, JSON.stringify(brands));
        }
        if(!localStorage.getItem(KEYS.devices)){
          const [apple, samsung, lenovo, xiaomi] = Utils.safeJSON(localStorage.getItem(KEYS.brands), []);
          const devices = [
            {
              id: Utils.uid(),
              name: 'iPhone 15 Pro',
              brandId: apple.id,
              type: 'móvil',
              releaseDate: '2023-09-22',
              price: 5999900,
              shortDesc: 'Titanio, chip A17 Pro, cámaras Pro.',
              review: 'Un tope de gama con excelente rendimiento y cámaras versátiles. La batería es sólida y el peso reducido se agradece.',
              images: ['https://images.unsplash.com/photo-1695048133506-26f3856fc0d9?q=80&w=1470&auto=format&fit=crop'],
              specs: { Pantalla: '6.1" OLED 120Hz', Procesador: 'A17 Pro', RAM: '8 GB', Almacenamiento: '256 GB', Batería: '3274 mAh', SO: 'iOS' }
            },
            {
              id: Utils.uid(),
              name: 'Galaxy S24 Ultra',
              brandId: samsung.id,
              type: 'móvil',
              releaseDate: '2024-01-31',
              price: 6999900,
              shortDesc: 'Cámara 200 MP, S Pen, funciones IA.',
              review: 'Excelente pantalla y zoom. El S Pen añade valor real. La IA ayuda en edición y resumen.',
              images: ['https://images.unsplash.com/photo-1706868791334-1e05c770d34a?q=80&w=1470&auto=format&fit=crop'],
              specs: { Pantalla: '6.8" AMOLED 120Hz', Procesador: 'Snapdragon 8 Gen 3', RAM: '12 GB', Almacenamiento: '256 GB', Batería: '5000 mAh', SO: 'Android' }
            },
            {
              id: Utils.uid(),
              name: 'Lenovo Yoga Slim 7',
              brandId: lenovo.id,
              type: 'portátil',
              releaseDate: '2023-05-15',
              price: 4299900,
              shortDesc: 'Ultraligero, gran batería y buen teclado.',
              review: 'Ideal para estudiantes y profesionales; equilibrio entre portabilidad y rendimiento.',
              images: ['https://images.unsplash.com/photo-1527443154391-507e9dc6c5cc?q=80&w=1470&auto=format&fit=crop'],
              specs: { Pantalla: '14" IPS', Procesador: 'Ryzen 7', RAM: '16 GB', Almacenamiento: '512 GB SSD', SO: 'Windows 11' }
            },
            {
              id: Utils.uid(),
              name: 'Xiaomi 14',
              brandId: xiaomi.id,
              type: 'móvil',
              releaseDate: '2024-02-26',
              price: 3499900,
              shortDesc: 'Cámaras Leica y gran rendimiento.',
              review: 'Relación calidad-precio destacada, buen software y gran autonomía.',
              images: ['https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?q=80&w=1470&auto=format&fit=crop'],
              specs: { Pantalla: '6.36" AMOLED 120Hz', Procesador: 'Snapdragon 8 Gen 3', RAM: '12 GB', Almacenamiento: '256 GB', Batería: '4610 mAh', SO: 'Android' }
            },
          ];
          localStorage.setItem(KEYS.devices, JSON.stringify(devices));
        }
        if(!localStorage.getItem(KEYS.comments)){
          localStorage.setItem(KEYS.comments, JSON.stringify([]));
        }
      }
      seedIfEmpty();

      const read = k => Utils.safeJSON(localStorage.getItem(k), []);
      const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      return {
        brands: {
          list: () => read(KEYS.brands),
          add: name => {
            const brands = read(KEYS.brands);
            if (brands.some(b => b.name.toLowerCase() === name.trim().toLowerCase())) return null;
            const b = { id: Utils.uid(), name: name.trim() };
            brands.push(b); write(KEYS.brands, brands);
            EventBus.emit('brands:changed');
            return b;
          },
          get: id => read(KEYS.brands).find(b => b.id === id) || null
        },
        devices: {
          listRaw: () => read(KEYS.devices),
          upsert: (dev) => {
            const arr = read(KEYS.devices);
            const idx = arr.findIndex(d => d.id === dev.id);
            if(idx >= 0) arr[idx] = dev; else arr.push(dev);
            write(KEYS.devices, arr);
            EventBus.emit('devices:changed');
            return dev;
          },
          delete: (id) => {
            const arr = read(KEYS.devices).filter(d => d.id !== id);
            write(KEYS.devices, arr);
            EventBus.emit('devices:changed');
          },
          get: id => read(KEYS.devices).find(d => d.id === id) || null
        },
        comments: {
          listByDevice: deviceId => read(KEYS.comments)
            .filter(c => c.deviceId === deviceId)
            .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)),
          add: ({deviceId, author, rating, text}) => {
            const c = { id: Utils.uid(), deviceId, author: author?.trim() || 'Anónimo', rating: Number(rating)||5, text: text.trim(), createdAt: new Date().toISOString() };
            const all = read(KEYS.comments); all.push(c);
            write(KEYS.comments, all);
            EventBus.emit('comments:changed', deviceId);
            return c;
          }
        }
      }
    })();

    /* ======================== *
     *  Capa de Servicios (API) *
     * ======================== */
    const DeviceService = {
      list({ q='', brandId='', type='', sort='release_desc' } = {}){
        const data = Store.devices.listRaw().map(d => ({
          ...d,
          brandName: Store.brands.get(d.brandId)?.name || '—'
        }));
        const text = q.trim().toLowerCase();
        let res = data.filter(d => {
          const hitText = !text || [d.name, d.brandName, d.shortDesc].some(v => (v||'').toLowerCase().includes(text));
          const hitBrand = !brandId || d.brandId === brandId;
          const hitType = !type || d.type === type;
          return hitText && hitBrand && hitType;
        });
        if (sort === 'release_asc') res.sort((a,b) => new Date(a.releaseDate)-new Date(b.releaseDate));
        else if (sort === 'price_asc') res.sort((a,b) => (a.price||0)-(b.price||0));
        else if (sort === 'price_desc') res.sort((a,b) => (b.price||0)-(a.price||0));
        else /* release_desc */ res.sort((a,b) => new Date(b.releaseDate)-new Date(a.releaseDate));
        return res;
      },
      getById: id => {
        const d = Store.devices.get(id);
        if(!d) return null;
        return { ...d, brandName: Store.brands.get(d.brandId)?.name || '—' };
      },
      create(payload){
        const dev = {
          id: Utils.uid(),
          name: payload.name.trim(),
          brandId: payload.brandId,
          type: payload.type,
          releaseDate: payload.releaseDate,
          price: Number(payload.price)||null,
          shortDesc: payload.shortDesc?.trim() || '',
          review: payload.review?.trim() || '',
          images: (payload.images || []).filter(Boolean),
          specs: payload.specs || {}
        };
        return Store.devices.upsert(dev);
      },
      update(id, patch){
        const cur = Store.devices.get(id);
        if(!cur) return null;
        const next = { ...cur, ...patch };
        return Store.devices.upsert(next);
      },
      remove: id => Store.devices.delete(id),
      brands: {
        list: () => Store.brands.list(),
        add: name => Store.brands.add(name)
      },
      comments: {
        forDevice: id => Store.comments.listByDevice(id),
        add: (deviceId, author, rating, text) => Store.comments.add({ deviceId, author, rating, text })
      }
    };

    /* ============== *
     *  Router simple *
     * ============== */
    const Router = (() => {
      const routes = [];
      function add(pattern, handler){ routes.push({ pattern, handler }); }
      function parse(){
        const { route } = Utils.getQuery();
        for(const r of routes){
          const match = route.match(r.pattern);
          if(match) return r.handler(...match.slice(1));
        }
        // default
        Views.Home.render();
      }
      window.addEventListener('hashchange', parse);
      return { add, parse };
    })();

    /* ======================= *
     *  Componentes / Vistas   *
     * ======================= */
    const Views = {};

    // ---- HOME (listado + filtros) ----
    Views.Home = {
      render(){
        const { params } = Utils.getQuery();
        const q = params.get('q') || '';
        const brandId = params.get('brand') || '';
        const type = params.get('type') || '';
        const sort = params.get('sort') || 'release_desc';
        const brands = DeviceService.brands.list();
        const devices = DeviceService.list({ q, brandId, type, sort });

        Utils.qs('#app').innerHTML = `
          <section class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button class="btn btn-outline-secondary d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#filtersCanvas">
                <i class="bi bi-filter"></i> Filtros
              </button>
              <div class="ms-auto text-muted small">${devices.length} resultados</div>
            </div>
          </section>

          <section class="row gy-4">
            <aside class="col-lg-3 d-none d-lg-block">
              ${this.filtersHTML({ q, brandId, type, sort, brands })}
            </aside>
            <div class="col-lg-9">
              <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                ${devices.map(this.card).join('') || `
                  <div class="col">
                    <div class="p-4 empty-hint text-center text-muted">
                      <i class="bi bi-search fs-4 d-block mb-2"></i>
                      No hay resultados. Ajusta filtros o términos de búsqueda.
                    </div>
                  </div>`}
              </div>
            </div>
          </section>

          <!-- Offcanvas Filtros (móvil) -->
          <div class="offcanvas offcanvas-start" tabindex="-1" id="filtersCanvas">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title"><i class="bi bi-filter"></i> Filtros</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
            </div>
            <div class="offcanvas-body">
              ${this.filtersHTML({ q, brandId, type, sort, brands, inCanvas:true })}
            </div>
          </div>
        `;

        // wire filters
        this.bindFilters();
        // sync search in navbar
        Utils.qs('#navSearchInput').value = q;
      },
      card(d){
        const img = (d.images && d.images[0]) || 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?q=80&w=1470&auto=format&fit=crop';
        return `
          <div class="col">
            <div class="card device-card h-100 shadow-sm">
              <img src="${img}" class="card-img-top" alt="${d.name}">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <span class="badge text-bg-secondary badge-type">${d.type}</span>
                  <span class="text-muted small">${Utils.fmtDate(d.releaseDate)}</span>
                </div>
                <h6 class="card-title mb-1">${d.name}</h6>
                <div class="text-muted small mb-2">${d.brandName}</div>
                <p class="card-text small flex-grow-1">${d.shortDesc || ''}</p>
                <div class="d-flex align-items-center justify-content-between">
                  <span class="fw-semibold">${d.price ? Utils.fmtPrice(d.price) : ''}</span>
                  <a class="btn btn-primary btn-sm" href="#/device/${d.id}">
                    Ver detalles <i class="bi bi-arrow-right-short"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>`;
      },
      filtersHTML({ q, brandId, type, sort, brands }){
        return `
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Buscar</label>
                <input id="f-q" type="search" class="form-control" placeholder="Nombre, marca..." value="${q}">
              </div>
              <div class="mb-3">
                <label class="form-label">Marca</label>
                <select id="f-brand" class="form-select">
                  <option value="">Todas</option>
                  ${brands.map(b => `<option value="${b.id}" ${b.id===brandId?'selected':''}>${b.name}</option>`).join('')}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Tipo</label>
                <select id="f-type" class="form-select">
                  ${['', 'móvil', 'portátil', 'tablet', 'wearable'].map(t => `<option value="${t}" ${t===type?'selected':''}>${t||'Todos'}</option>`).join('')}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Ordenar por</label>
                <select id="f-sort" class="form-select">
                  <option value="release_desc" ${sort==='release_desc'?'selected':''}>Fecha lanzamiento (nuevo → viejo)</option>
                  <option value="release_asc" ${sort==='release_asc'?'selected':''}>Fecha lanzamiento (viejo → nuevo)</option>
                  <option value="price_desc" ${sort==='price_desc'?'selected':''}>Precio (alto → bajo)</option>
                  <option value="price_asc" ${sort==='price_asc'?'selected':''}>Precio (bajo → alto)</option>
                </select>
              </div>
              <div class="d-grid gap-2">
                <button id="f-apply" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Aplicar</button>
                <button id="f-clear" class="btn btn-outline-secondary"><i class="bi bi-eraser"></i> Limpiar</button>
              </div>
            </div>
          </div>`;
      },
      bindFilters(){
        const { params } = Utils.getQuery();
        const apply = () => {
          const q = Utils.qs('#f-q')?.value || '';
          const brand = Utils.qs('#f-brand')?.value || '';
          const type  = Utils.qs('#f-type')?.value || '';
          const sort  = Utils.qs('#f-sort')?.value || 'release_desc';
          Utils.setQuery({ q, brand, type, sort });
        };
        Utils.qs('#f-apply')?.addEventListener('click', apply);
        Utils.qs('#f-clear')?.addEventListener('click', () => {
          Utils.setQuery({});
        });

        // nav search
        Utils.qs('#navSearchForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const q = Utils.qs('#navSearchInput').value || '';
          const brand = params.get('brand') || '';
          const type = params.get('type') || '';
          const sort = params.get('sort') || 'release_desc';
          Utils.setQuery({ q, brand, type, sort });
        });
      }
    };

    // ---- DETALLE ----
    Views.Detail = {
      render(id){
        const d = DeviceService.getById(id);
        if(!d){
          Utils.qs('#app').innerHTML = `
            <div class="alert alert-warning">
              Dispositivo no encontrado. <a href="#/">Volver al inicio</a>
            </div>`;
          return;
        }
        const comments = DeviceService.comments.forDevice(d.id);
        Utils.qs('#app').innerHTML = `
          <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#/">Inicio</a></li>
              <li class="breadcrumb-item active" aria-current="page">${d.name}</li>
            </ol>
          </nav>

          <section class="row g-4">
            <div class="col-md-6">
              ${this.gallery(d.images)}
            </div>
            <div class="col-md-6">
              <h2 class="h4 mb-1">${d.name}</h2>
              <div class="text-muted mb-2">${d.brandName} • ${d.type} • Lanzamiento: ${Utils.fmtDate(d.releaseDate)}</div>
              <div class="h5 mb-3">${d.price ? Utils.fmtPrice(d.price) : ''}</div>
              <p class="mb-3">${d.shortDesc || ''}</p>
              <div class="mb-4">
                <h6 class="mb-2">Especificaciones</h6>
                ${this.specsTable(d.specs)}
              </div>
            </div>
          </section>

          <section class="mt-4">
            <h3 class="h5">Reseña</h3>
            <p>${d.review || 'Sin reseña.'}</p>
          </section>

          <section class="mt-4">
            <h3 class="h5 d-flex align-items-center justify-content-between">
              Comentarios <span class="badge text-bg-secondary">${comments.length}</span>
            </h3>
            <div class="vstack gap-3 my-3">
              ${comments.map(this.commentItem).join('') || `
                <div class="p-4 empty-hint text-center text-muted">
                  <i class="bi bi-chat-dots fs-4 d-block mb-2"></i>
                  Aún no hay comentarios. ¡Sé el primero!
                </div>`}
            </div>
            ${this.commentForm(d.id)}
          </section>
        `;

        this.bindCommentForm(d.id);
        // actualizar dinámicamente si cambian comentarios
        const onChange = devId => {
          if (devId !== d.id) return;
          this.render(d.id);
        };
        EventBus.on('comments:changed', onChange);
      },
      gallery(imgs=[]){
        if(!imgs.length) imgs = ['https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?q=80&w=1470&auto=format&fit=crop'];
        const id = 'carousel-'+Utils.uid();
        const slides = imgs.map((src,i)=>`
          <div class="carousel-item ${i===0?'active':''}">
            <img src="${src}" class="d-block w-100" alt="Foto ${i+1}">
          </div>`).join('');
        return `
          <div id="${id}" class="carousel slide shadow-sm rounded overflow-hidden">
            <div class="carousel-inner">${slides}</div>
            ${imgs.length>1 ? `
              <button class="carousel-control-prev" type="button" data-bs-target="#${id}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#${id}" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Siguiente</span>
              </button>` : ''}
          </div>`;
      },
      specsTable(specs={}){
        const rows = Object.entries(specs).map(([k,v])=>`
          <div class="d-flex gap-3 py-1 border-bottom">
            <div class="spec-key">${k}</div>
            <div class="flex-grow-1">${v}</div>
          </div>`).join('');
        return `<div class="border rounded">${rows || '<div class="p-3 text-muted">Sin especificaciones.</div>'}</div>`;
      },
      commentItem(c){
        return `
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>${c.author}</strong>
                <small class="text-muted">${new Date(c.createdAt).toLocaleString('es-CO')}</small>
              </div>
              <div class="mb-2">${Utils.stars(c.rating)}</div>
              <p class="mb-0">${c.text}</p>
            </div>
          </div>`;
      },
      commentForm(deviceId){
        return `
          <form id="commentForm" class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Nombre</label>
                  <input name="author" type="text" class="form-control" placeholder="Tu nombre (opcional)">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Calificación</label>
                  <select name="rating" class="form-select">
                    ${[5,4,3,2,1].map(v=>`<option value="${v}">${v}</option>`).join('')}
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Comentario</label>
                  <textarea name="text" class="form-control" rows="3" required minlength="5" placeholder="¿Qué te pareció este dispositivo?"></textarea>
                  <div class="form-text">Sé respetuoso y específico. Mínimo 5 caracteres.</div>
                </div>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-end gap-2">
              <a href="#/" class="btn btn-outline-secondary">Volver</a>
              <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i> Publicar</button>
            </div>
          </form>`;
      },
      bindCommentForm(deviceId){
        Utils.qs('#commentForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const fd = new FormData(e.currentTarget);
          const text = (fd.get('text')||'').toString().trim();
          if(text.length<5){
            Utils.showToast({ title:'Ups', body:'El comentario es muy corto.', variant:'warning' }); return;
          }
          DeviceService.comments.add(deviceId, fd.get('author'), fd.get('rating'), text);
          Utils.showToast({ title:'Gracias', body:'Comentario publicado', variant:'success' });
          e.currentTarget.reset();
        });
      }
    };

    // ---- ADMIN ----
    Views.Admin = {
      render(){
        const brands = DeviceService.brands.list();
        const devices = DeviceService.list({});
        Utils.qs('#app').innerHTML = `
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h4 mb-0"><i class="bi bi-gear"></i> Administración</h2>
            <a class="btn btn-outline-primary" href="#/">Ir al inicio</a>
          </div>

          <div class="row g-4">
            <div class="col-lg-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">Marcas</h5>
                  <div class="input-group mb-2">
                    <input id="brandName" type="text" class="form-control" placeholder="Nombre de la marca">
                    <button id="addBrandBtn" class="btn btn-primary"><i class="bi bi-plus-lg"></i></button>
                  </div>
                  <ul class="list-group small" id="brandsList">
                    ${brands.map(b=>`<li class="list-group-item d-flex justify-content-between align-items-center">
                      ${b.name}<span class="badge text-bg-secondary">${b.id.slice(0,6)}</span>
                    </li>`).join('')}
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-lg-8">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">Nuevo/Editar dispositivo</h5>
                  ${this.deviceFormHTML(brands)}
                </div>
              </div>

              <div class="card border-0 shadow-sm mt-4">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">Inventario (${devices.length})</h5>
                    <div class="text-muted small">Click en <i class="bi bi-pencil"></i> para cargar el formulario</div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle mt-2">
                      <thead class="table-light">
                        <tr>
                          <th class="table-fixed-2"></th>
                          <th>Nombre</th>
                          <th>Marca</th>
                          <th class="table-fixed-5">Tipo</th>
                          <th>Lanzamiento</th>
                          <th>Precio</th>
                          <th class="table-fixed-2"></th>
                        </tr>
                      </thead>
                      <tbody id="devicesTable">
                        ${devices.map(d=>this.row(d)).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-3">
                <strong>Siguiente paso (Back-end):</strong> expón un API REST <code>/api/devices</code>, <code>/api/brands</code>, <code>/api/comments</code>.
                Cambia la capa de servicios para usar <code>fetch()</code> en lugar de <code>localStorage</code>.
              </div>
            </div>
          </div>
        `;
        this.bind();
      },
      deviceFormHTML(brands){
        return `
          <form id="deviceForm" class="row g-3">
            <input type="hidden" name="id" value="">
            <div class="col-md-8">
              <label class="form-label">Nombre</label>
              <input name="name" type="text" class="form-control" required placeholder="p.ej. Galaxy S24 Ultra">
            </div>
            <div class="col-md-4">
              <label class="form-label">Tipo</label>
              <select name="type" class="form-select" required>
                ${['móvil','portátil','tablet','wearable'].map(t=>`<option value="${t}">${t}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Marca</label>
              <select name="brandId" class="form-select" required>
                ${brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}
              </select>
              <div class="form-text">¿No ves tu marca? Agrégala a la izquierda.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Fecha de lanzamiento</label>
              <input name="releaseDate" type="date" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Precio (COP)</label>
              <input name="price" type="number" min="0" step="1000" class="form-control" placeholder="0">
            </div>
            <div class="col-12">
              <label class="form-label">Descripción corta</label>
              <input name="shortDesc" type="text" class="form-control" placeholder="Resumen breve...">
            </div>
            <div class="col-12">
              <label class="form-label">Reseña</label>
              <textarea name="review" rows="3" class="form-control" placeholder="Opinión, puntos fuertes y débiles..."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Imágenes (URLs)</label>
              <div id="imagesGroup" class="vstack gap-2">
                <div class="input-group"><input name="image" type="url" class="form-control" placeholder="https://..."><button class="btn btn-outline-secondary add-img" type="button"><i class="bi bi-plus-lg"></i></button></div>
              </div>
              <div class="form-text monospace">Aloja imágenes públicas (Unsplash/Imgbb/etc.).</div>
            </div>

            <div class="col-12">
              <label class="form-label">Especificaciones (clave: valor)</label>
              <div id="specsGroup" class="vstack gap-2">
                ${['Pantalla','Procesador','RAM','Almacenamiento','Batería','SO'].map(k => `
                  <div class="input-group">
                    <input name="specKey" type="text" class="form-control" placeholder="${k}">
                    <input name="specVal" type="text" class="form-control" placeholder="Valor">
                    <button class="btn btn-outline-secondary add-spec" type="button"><i class="bi bi-plus-lg"></i></button>
                  </div>`).join('')}
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
              <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Guardar</button>
            </div>
          </form>
        `;
      },
      row(d){
        return `
          <tr data-id="${d.id}">
            <td><a class="text-decoration-none" href="#/device/${d.id}" title="Ver"><i class="bi bi-box-arrow-up-right"></i></a></td>
            <td>${d.name}</td>
            <td>${d.brandName}</td>
            <td class="text-capitalize">${d.type}</td>
            <td>${Utils.fmtDate(d.releaseDate)}</td>
            <td>${d.price ? Utils.fmtPrice(d.price) : ''}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-secondary me-1 btn-edit" title="Editar"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger btn-del" title="Eliminar"><i class="bi bi-trash"></i></button>
            </td>
          </tr>`;
      },
      bind(){
        // Agregar marca
        Utils.qs('#addBrandBtn').addEventListener('click', () => {
          const name = Utils.qs('#brandName').value.trim();
          if(!name) return;
          const b = DeviceService.brands.add(name);
          if(!b) { Utils.showToast({ title:'Atención', body:'La marca ya existe', variant:'warning' }); return; }
          Utils.showToast({ title:'Ok', body:'Marca agregada', variant:'success' });
          this.render(); // recargar para refrescar selects/lista
        });

        // Añadir filas dinámicas
        Utils.qsa('.add-img').forEach(btn => btn.addEventListener('click', () => {
          const wrap = Utils.qs('#imagesGroup');
          const row = document.createElement('div');
          row.className = 'input-group';
          row.innerHTML = `<input name="image" type="url" class="form-control" placeholder="https://...">
                           <button class="btn btn-outline-danger remove-img" type="button"><i class="bi bi-x-lg"></i></button>`;
          wrap.appendChild(row);
          row.querySelector('.remove-img').addEventListener('click', () => row.remove());
        }));
        Utils.qsa('.add-spec').forEach(btn => btn.addEventListener('click', () => {
          const wrap = Utils.qs('#specsGroup');
          const row = document.createElement('div');
          row.className = 'input-group';
          row.innerHTML = `<input name="specKey" type="text" class="form-control" placeholder="Clave">
                           <input name="specVal" type="text" class="form-control" placeholder="Valor">
                           <button class="btn btn-outline-danger remove-spec" type="button"><i class="bi bi-x-lg"></i></button>`;
          wrap.appendChild(row);
          row.querySelector('.remove-spec').addEventListener('click', () => row.remove());
        }));

        // Guardar dispositivo
        Utils.qs('#deviceForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const fd = new FormData(e.currentTarget);
          const id = fd.get('id');
          const images = Utils.qsa('input[name="image"]').map(i => i.value.trim()).filter(Boolean);
          const specKeys = Utils.qsa('input[name="specKey"]').map(i => i.value.trim());
          const specVals = Utils.qsa('input[name="specVal"]').map(i => i.value.trim());
          const specs = {};
          specKeys.forEach((k,i)=>{ if(k && specVals[i]) specs[k]=specVals[i] });

          const payload = {
            name: fd.get('name'),
            brandId: fd.get('brandId'),
            type: fd.get('type'),
            releaseDate: fd.get('releaseDate'),
            price: fd.get('price'),
            shortDesc: fd.get('shortDesc'),
            review: fd.get('review'),
            images,
            specs
          };

          if (id) DeviceService.update(id, payload);
          else DeviceService.create(payload);

          Utils.showToast({ title:'Guardado', body:'Dispositivo registrado', variant:'success' });
          e.currentTarget.reset();
          Views.Admin.render();
        });

        // Editar / Eliminar filas
        Utils.qsa('#devicesTable .btn-edit').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const tr = e.currentTarget.closest('tr');
            const id = tr.getAttribute('data-id');
            const d = DeviceService.getById(id);
            const form = Utils.qs('#deviceForm');
            form.reset();
            form.querySelector('[name="id"]').value = d.id;
            form.querySelector('[name="name"]').value = d.name;
            form.querySelector('[name="type"]').value = d.type;
            form.querySelector('[name="brandId"]').value = d.brandId;
            form.querySelector('[name="releaseDate"]').value = d.releaseDate.slice(0,10);
            form.querySelector('[name="price"]').value = d.price || '';
            form.querySelector('[name="shortDesc"]').value = d.shortDesc || '';
            form.querySelector('[name="review"]').value = d.review || '';

            // re-crear imágenes
            const imgWrap = Utils.qs('#imagesGroup'); imgWrap.innerHTML = '';
            (d.images||['']).forEach((url, idx) => {
              const row = document.createElement('div');
              row.className = 'input-group mb-2';
              row.innerHTML = `<input name="image" type="url" class="form-control" placeholder="https://..." value="${url}">
                               ${idx===0 ? '<button class="btn btn-outline-secondary add-img" type="button"><i class="bi bi-plus-lg"></i></button>'
                                          : '<button class="btn btn-outline-danger remove-img" type="button"><i class="bi bi-x-lg"></i></button>'}`;
              imgWrap.appendChild(row);
            });
            Views.Admin.bind(); // re-wire botones dinámicos

            // re-crear specs
            const specWrap = Utils.qs('#specsGroup'); specWrap.innerHTML = '';
            const entries = Object.entries(d.specs||{});
            if(!entries.length){
              const row = document.createElement('div');
              row.className = 'input-group';
              row.innerHTML = `<input name="specKey" type="text" class="form-control" placeholder="Clave">
                               <input name="specVal" type="text" class="form-control" placeholder="Valor">
                               <button class="btn btn-outline-secondary add-spec" type="button"><i class="bi bi-plus-lg"></i></button>`;
              specWrap.appendChild(row);
            } else {
              entries.forEach(([k,v], idx)=>{
                const row = document.createElement('div');
                row.className = 'input-group mb-2';
                row.innerHTML = `<input name="specKey" type="text" class="form-control" value="${k}">
                                 <input name="specVal" type="text" class="form-control" value="${v}">
                                 ${idx===0 ? '<button class="btn btn-outline-secondary add-spec" type="button"><i class="bi bi-plus-lg"></i></button>'
                                            : '<button class="btn btn-outline-danger remove-spec" type="button"><i class="bi bi-x-lg"></i></button>'}`;
                specWrap.appendChild(row);
              });
            }
            Views.Admin.bind();
            Utils.showToast({ title:'Edición', body:'Formulario cargado', variant:'primary' });
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        });
        Utils.qsa('#devicesTable .btn-del').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const tr = e.currentTarget.closest('tr');
            const id = tr.getAttribute('data-id');
            if(confirm('¿Eliminar este dispositivo?')){
              DeviceService.remove(id);
              Utils.showToast({ title:'Eliminado', body:'Dispositivo eliminado', variant:'secondary' });
              Views.Admin.render();
            }
          });
        });
      }
    };

    /* ============ *
     *  Rutas       *
     * ============ */
    Router.add(/^#\/?$/, () => Views.Home.render());
    Router.add(/^#\/device\/(.+)$/, (id) => Views.Detail.render(id));
    Router.add(/^#\/admin\/?$/, () => Views.Admin.render());

    // Lanzar app
    document.addEventListener('DOMContentLoaded', () => {
      Router.parse();
      EventBus.on('devices:changed', () => {
        const { route } = Utils.getQuery();
        if (route.startsWith('#/admin')) Views.Admin.render();
        else Views.Home.render();
      });
    });
  })();
  </script>